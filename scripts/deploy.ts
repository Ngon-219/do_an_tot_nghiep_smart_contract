import { ethers } from "hardhat";

async function main() {
    console.log("=".repeat(70));
    console.log("üöÄ SMART CONTRACT DEPLOYMENT - EDUCATION MANAGEMENT SYSTEM");
    console.log("=".repeat(70));
    console.log();

    // Get deployer info
    const [deployer] = await ethers.getSigners();
    const balance = await ethers.provider.getBalance(deployer.address);
    
    console.log("üë§ Deployer Information:");
    console.log("   Address:", deployer.address);
    console.log("   Balance:", ethers.formatEther(balance), "ETH");
    console.log();

    const deployedContracts: { [key: string]: string } = {};

    try {
        console.log("üì¶ [1/3] Deploying FactoryContract...");
        console.log("   (This will automatically deploy DataStorage, IssuanceOfDocument & DocumentNFT)");
        
        const FactoryContract = await ethers.getContractFactory("FactoryContract");
        const factoryContract = await FactoryContract.deploy();
        await factoryContract.waitForDeployment();
        
        const factoryAddress = await factoryContract.getAddress();
        deployedContracts["FactoryContract"] = factoryAddress;
        console.log("   ‚úÖ FactoryContract:", factoryAddress);

        const dataStorageAddress = await factoryContract.getDataStorageAddress();
        const issuanceAddress = await factoryContract.getIssuanceContractAddress();
        const documentNFTAddress = await factoryContract.getDocumentNFTAddress();
        
        deployedContracts["DataStorage"] = dataStorageAddress;
        deployedContracts["IssuanceOfDocument"] = issuanceAddress;
        deployedContracts["DocumentNFT"] = documentNFTAddress;
        
        console.log("   ‚úÖ DataStorage:", dataStorageAddress);
        console.log("   ‚úÖ IssuanceOfDocument:", issuanceAddress);
        console.log("   ‚úÖ DocumentNFT (ERC-721):", documentNFTAddress);
        console.log();

        console.log("üìä [2/3] Deploying StudentViolation Contract...");
        
        const deployScoreTx = await factoryContract.deployStudentScore();
        await deployScoreTx.wait();
        
        const studentScoreContracts = await factoryContract.getAllStudentScoreContracts();
        const studentViolationAddress = studentScoreContracts[studentScoreContracts.length - 1];
        
        deployedContracts["StudentViolation"] = studentViolationAddress;
        console.log("   ‚úÖ StudentViolation:", studentViolationAddress);
        console.log();

        console.log("üó≥Ô∏è  [3/3] Deploying VotingContract...");
        
        const deployVotingTx = await factoryContract.deployVotingContract();
        await deployVotingTx.wait();
        
        const votingContracts = await factoryContract.getAllVotingContracts();
        const votingAddress = votingContracts[votingContracts.length - 1];
        
        deployedContracts["VotingContract"] = votingAddress;
        console.log("   ‚úÖ VotingContract:", votingAddress);
        console.log();

        console.log("=".repeat(70));
        console.log("‚úÖ ALL CONTRACTS DEPLOYED SUCCESSFULLY!");
        console.log("=".repeat(70));
        console.log();

        console.log("üìã DEPLOYMENT SUMMARY:");
        console.log("-".repeat(70));
        
        const contractOrder = [
            "FactoryContract",
            "DataStorage",
            "IssuanceOfDocument",
            "DocumentNFT",
            "StudentViolation",
            "VotingContract"
        ];
        
        contractOrder.forEach((name) => {
            if (deployedContracts[name]) {
                const padding = " ".repeat(Math.max(0, 25 - name.length));
                console.log(`${name}${padding}: ${deployedContracts[name]}`);
            }
        });
        
        console.log("-".repeat(70));
        console.log();

        const systemInfo = await factoryContract.getSystemInfo();
        
        console.log("üìä SYSTEM INFORMATION:");
        console.log("-".repeat(70));
        console.log(`DataStorage Address       : ${systemInfo[0]}`);
        console.log(`IssuanceOfDocument Addr   : ${systemInfo[1]}`);
        console.log(`DocumentNFT Address       : ${systemInfo[2]}`);
        console.log(`Total Students            : ${systemInfo[3].toString()}`);
        console.log(`Total Managers            : ${systemInfo[4].toString()}`);
        console.log(`StudentViolation Instances: ${systemInfo[5].toString()}`);
        console.log(`VotingContract Instances  : ${systemInfo[6].toString()}`);
        console.log("-".repeat(70));
        console.log();

        const network = await ethers.provider.getNetwork();
        
        console.log("üåê NETWORK INFORMATION:");
        console.log("-".repeat(70));
        console.log(`Network Name              : ${network.name}`);
        console.log(`Chain ID                  : ${network.chainId.toString()}`);
        console.log(`Deployer Address          : ${deployer.address}`);
        console.log(`Deployment Time           : ${new Date().toISOString()}`);
        console.log("-".repeat(70));
        console.log();

        const fs = await import('fs');
        const deploymentData = {
            metadata: {
                network: network.name,
                chainId: network.chainId.toString(),
                deployedAt: new Date().toISOString(),
                deployerAddress: deployer.address,
                version: "1.0.0"
            },
            architecture: {
                description: "Centralized DataStorage pattern with Factory deployment + NFT Documents",
                components: {
                    core: "DataStorage - Single source of truth for all data",
                    factory: "FactoryContract - Manages deployment and authorization",
                    nft: "DocumentNFT - ERC-721 NFT for education documents",
                    logic: [
                        "IssuanceOfDocument - Manager signs documents & mints NFTs",
                        "StudentViolation - Track violation points",
                        "VotingContract - Student voting system"
                    ]
                },
                roles: ["NONE", "STUDENT", "TEACHER", "ADMIN", "MANAGER"]
            },
            contracts: deployedContracts,
            systemInfo: {
                totalStudents: systemInfo[3].toString(),
                totalManagers: systemInfo[4].toString(),
                studentViolationInstances: systemInfo[5].toString(),
                votingContractInstances: systemInfo[6].toString()
            },
            quickStart: {
                "1_add_manager": {
                    contract: "DataStorage",
                    function: "addManager(address)",
                    description: "Add a manager who can sign documents"
                },
                "2_assign_teacher": {
                    contract: "DataStorage",
                    function: "assignRole(address, Role.TEACHER)",
                    description: "Assign teacher role to user"
                },
                "3_register_students": {
                    contract: "DataStorage",
                    function: "registerStudent(...) or registerStudentsBatch(...)",
                    description: "Register students to the system"
                },
                "4_initialize_violations": {
                    contract: "StudentViolation",
                    function: "initializeViolation(studentId, semester, points)",
                    description: "Initialize violation points for students"
                },
                "5_sign_documents": {
                    contract: "IssuanceOfDocument",
                    function: "signDocument(hash, studentId, type, tokenURI)",
                    description: "Manager signs documents and mints NFT to student wallet"
                },
                "6_create_voting": {
                    contract: "VotingContract",
                    function: "createVotingEvent(name, description, options, duration)",
                    description: "Teacher/Manager creates voting events"
                }
            }
        };
        
        const filename = `deployment-${network.name}-${Date.now()}.json`;
        fs.writeFileSync(filename, JSON.stringify(deploymentData, null, 2));
        
        console.log("üíæ DEPLOYMENT DATA SAVED:");
        console.log(`   File: ${filename}`);
        console.log();

        console.log("üìù NEXT STEPS TO USE THE SYSTEM:");
        console.log("-".repeat(70));
        console.log("1Ô∏è‚É£  Add Managers:");
        console.log("    ‚Üí DataStorage.addManager(managerAddress)");
        console.log();
        console.log("2Ô∏è‚É£  Assign Teachers:");
        console.log("    ‚Üí DataStorage.assignRole(teacherAddress, Role.TEACHER)");
        console.log();
        console.log("3Ô∏è‚É£  Register Students:");
        console.log("    ‚Üí DataStorage.registerStudent(address, code, name, email)");
        console.log("    ‚Üí DataStorage.registerStudentsBatch([addresses], [codes], [names], [emails])");
        console.log();
        console.log("4Ô∏è‚É£  Initialize Violation Points:");
        console.log("    ‚Üí StudentViolation.initializeViolation(studentId, semester, initialPoints)");
        console.log();
        console.log("5Ô∏è‚É£  Start Operations:");
        console.log("    ‚Üí Manager signs documents (mints NFT to student wallet)");
        console.log("    ‚Üí Teacher manages violation points");
        console.log("    ‚Üí Teacher/Manager creates voting events");
        console.log("    ‚Üí Students vote");
        console.log();
        console.log("üíé NFT Documents:");
        console.log("    ‚Üí Each document is minted as ERC-721 NFT");
        console.log("    ‚Üí Students own their education documents as NFTs");
        console.log("    ‚Üí View NFTs on OpenSea or other NFT marketplaces");
        console.log("-".repeat(70));
        console.log();

        console.log("=".repeat(70));
        console.log("üéâ DEPLOYMENT COMPLETED SUCCESSFULLY!");
        console.log("=".repeat(70));

    } catch (error) {
        console.error();
        console.error("‚ùå DEPLOYMENT FAILED!");
        console.error("=".repeat(70));
        console.error(error);
        throw error;
    }
}

main()
    .then(() => {
        console.log();
        process.exit(0);
    })
    .catch((error) => {
        console.error(error);
        process.exit(1);
    });